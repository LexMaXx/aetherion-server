# ‚úÖ –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "Player already in room"

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

–ò–∑ –ª–æ–≥–æ–≤ Render.com –º—ã –≤—ã—è–≤–∏–ª–∏ —Ç–æ—á–Ω—É—é –ø—Ä–∏—á–∏–Ω—É HTTP 500 –æ—à–∏–±–∫–∏:

```
[–ö–æ–º–Ω–∞—Ç–∞] TestPlayer –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ f5040710-ed23-4883-b576-7ba1dd6e095a
–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ: –û—à–∏–±–∫–∞: –ò–≥—Ä–æ–∫ —É–∂–µ –≤ –∫–æ–º–Ω–∞—Ç–µ
    –≤ roomSchema.methods.addPlayer (Room.js:97:15)
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –≤—ã—Ö–æ–¥–∏–ª –∏–∑ –∏–≥—Ä—ã, –æ–Ω –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É —Å–µ—Ä–≤–µ—Ä –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–ª —á—Ç–æ –∏–≥—Ä–æ–∫ —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ä–æ–π –∫–æ–º–Ω–∞—Ç–µ –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–ª –æ—à–∏–±–∫—É.

## üõ†Ô∏è –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **routes/room.js - POST /api/room/create**

**–î–æ:**
```javascript
const existingRoom = await Room.findOne({
    'players.userId': userId,
    status: { $in: ['waiting', 'in_progress'] }
});

if (existingRoom) {
    return res.status(400).json({
        success: false,
        message: 'You are already in a room'
    });
}
```

**–ü–æ—Å–ª–µ:**
```javascript
const existingRoom = await Room.findOne({
    'players.userId': userId,
    status: { $in: ['waiting', 'in_progress'] }
});

// –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤ –¥—Ä—É–≥–æ–π –∫–æ–º–Ω–∞—Ç–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ –Ω–µ—ë
if (existingRoom) {
    console.log(`[Room] User ${userId} is in room ${existingRoom.roomId}, auto-leaving...`);
    try {
        await existingRoom.removePlayer(userId);
        console.log(`[Room] User ${userId} auto-left previous room`);
    } catch (err) {
        console.error('[Room] Error auto-leaving previous room:', err);
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏
    }
}
```

‚úÖ –¢–µ–ø–µ—Ä—å –∏–≥—Ä–æ–∫ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∏–¥–∞–µ—Ç** —Å—Ç–∞—Ä—É—é –∫–æ–º–Ω–∞—Ç—É –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π!

### 2. **routes/room.js - POST /api/room/join**

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –≤ **—Ü–µ–ª–µ–≤–æ–π** –∫–æ–º–Ω–∞—Ç–µ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç success (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤ **–¥—Ä—É–≥–æ–π** –∫–æ–º–Ω–∞—Ç–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º –≤ –Ω–æ–≤—É—é
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```javascript
// –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –≤ –≠–¢–û–ô –∫–æ–º–Ω–∞—Ç–µ - –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—ë–º success
if (existingRoom && existingRoom.roomId === roomId) {
    console.log(`[Room] User ${userId} already in room ${roomId}, returning success`);
    return res.json({
        success: true,
        message: 'Already in room',
        room: { /* –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã */ }
    });
}

// –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤ –î–†–£–ì–û–ô –∫–æ–º–Ω–∞—Ç–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Ö–æ–¥–∏–º
if (existingRoom && existingRoom.roomId !== roomId) {
    // ... auto-leave logic
}
```

‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã JOIN —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω—ã (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ)!

### 3. **models/Room.js - addPlayer –º–µ—Ç–æ–¥**

**–î–æ:**
```javascript
const existingPlayer = this.players.find(p => p.userId.toString() === playerData.userId.toString());
if (existingPlayer) {
    throw new Error('Player already in room'); // ‚ùå –û—à–∏–±–∫–∞!
}
```

**–ü–æ—Å–ª–µ:**
```javascript
const existingPlayer = this.players.find(p => p.userId.toString() === playerData.userId.toString());
if (existingPlayer) {
    // –ò–≥—Ä–æ–∫ —É–∂–µ –≤ –∫–æ–º–Ω–∞—Ç–µ - –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
    console.log(`[Room] Player ${playerData.username} already in room, updating data`);
    Object.assign(existingPlayer, playerData);
    this.lastActivity = Date.now();
    return this.save();
}
```

‚úÖ –í–º–µ—Å—Ç–æ –∫—Ä–∞—à–∞ —Å–µ—Ä–≤–µ—Ä **–æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ** –∏–≥—Ä–æ–∫–∞!

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã** - –∏–≥—Ä–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∏–¥–∞–µ—Ç —Å—Ç–∞—Ä—É—é –∫–æ–º–Ω–∞—Ç—É
2. ‚úÖ **–í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–æ–∫
3. ‚úÖ **Graceful handling** - —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö
4. ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö Render.com
5. ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

- ‚ùå HTTP 500 Internal Server Error ‚Üí ‚úÖ HTTP 200 OK
- ‚ùå "Player already in room" error ‚Üí ‚úÖ Auto-leave previous room
- ‚ùå –ò–≥—Ä–æ–∫–∏ –∑–∞—Å—Ç—Ä–µ–≤–∞–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–∞—Ö ‚Üí ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É ‚Üí ‚úÖ –í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å

## üìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-5 –º–∏–Ω—É—Ç –¥–ª—è –¥–µ–ø–ª–æ—è

Render.com —Å–µ–π—á–∞—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ø–ª–æ–∏—Ç commit `5b95acf`.

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ–ø–ª–æ–π:

1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://dashboard.render.com
2. –°–µ—Ä–≤–∏—Å "aetherion-server" ‚Üí –≤–∫–ª–∞–¥–∫–∞ "Logs"
3. –ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:
   ```
   ==> Your service is live üéâ
   [Server] Running on port 10000
   [MongoDB] Connected
   ```

### –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –≤ Unity:

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–≥—Ä—É**
2. **–í–æ–π–¥–∏—Ç–µ** (–ª–æ–≥–∏–Ω/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
3. **–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞**
4. **–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É** - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ë–ï–ó –æ—à–∏–±–æ–∫!

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Unity Console:

```
[RoomManager] Create room request: {"roomName":"Test Arena",...}
[RoomManager] ‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: Test Arena (ID: ...)
[RoomManager] –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ WebSocket...
```

### –í –ª–æ–≥–∞—Ö Render.com –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:

```
[Room] User 673... is in room f5040710-..., auto-leaving...
[Room] User 673... auto-left previous room
[Room] Created: <new-room-id> by TestPlayer
```

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### Auto-cleanup —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–Ω–∞—Ç

–°–µ—Ä–≤–µ—Ä —É–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç:
- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞
- –ü—É—Å—Ç—ã–µ –∫–æ–º–Ω–∞—Ç—ã —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞

–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–π —á–∞—Å —á–µ—Ä–µ–∑ `setInterval` –≤ server.js.

### WebSocket integration

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è/–≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É:
1. Unity –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket —á–µ—Ä–µ–∑ SimpleWebSocketClient
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `joinRoom` event
3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç ArenaScene

## üêõ Troubleshooting

### –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –æ—à–∏–±–∫–∞ 500:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Render:**
   - Dashboard ‚Üí Logs
   - –ò—â–∏—Ç–µ `[Room]` –∏ `Error`

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Unity Console:**
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ `[RoomManager] Error response body: {...}`
   - –ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ MongoDB:**
   - –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–º–Ω–∞—Ç—ã:
   ```javascript
   db.rooms.deleteMany({ status: 'waiting' })
   ```

### –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Invalid user ID format":

–ü—Ä–æ–±–ª–µ–º–∞ –≤ JWT —Ç–æ–∫–µ–Ω–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. `SERVER_CODE/routes/auth.js` - –∫–∞–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–∫–µ–Ω
2. JWT –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π MongoDB ObjectId –≤ –ø–æ–ª–µ `id`

### –ï—Å–ª–∏ WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è SimpleWebSocketClient (stub implementation).
–î–ª—è –ø–æ–ª–Ω–æ–≥–æ multiplayer –Ω—É–∂–Ω–æ:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SocketIOUnity package
2. –ó–∞–º–µ–Ω–∏—Ç—å SimpleWebSocketClient –Ω–∞ OptimizedWebSocketClient
3. –ò–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å polling —á–µ—Ä–µ–∑ REST API

## üìä –°—Ç–∞—Ç—É—Å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –í–µ—Ä—Å–∏—è |
|-----------|--------|--------|
| Server Fix | ‚úÖ –ì–æ—Ç–æ–≤–æ | 2.0.2 |
| Git Commit | ‚úÖ –ó–∞–ø—É—à–µ–Ω | 5b95acf |
| Render Deploy | ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ | ~2-5 –º–∏–Ω |
| Unity Client | ‚úÖ –ì–æ—Ç–æ–≤ | - |
| Testing | ‚è≥ –û–∂–∏–¥–∞–µ—Ç | - |

---

**–î–∞—Ç–∞:** 2025-10-12
**–ê–≤—Ç–æ—Ä:** Claude Code Assistant
**Commits:** 446dee9, f6ec365, 5b95acf
