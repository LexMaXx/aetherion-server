using UnityEngine;
using System.Collections;
using System.Collections.Generic;
using System;
using Newtonsoft.Json;

/// <summary>
/// –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞
/// –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ —Å–µ—Ç–µ–≤—ã–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
/// </summary>
public class NetworkSyncManager : MonoBehaviour
{
    public static NetworkSyncManager Instance { get; private set; }

    [Header("Settings")]
    [SerializeField] private float positionSyncInterval = 0.05f; // 20 Hz –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è (–∫–∞–∫ –≤ MMO)
    [SerializeField] private bool syncEnabled = true;

    [Header("Spawn Points")]
    [SerializeField] private Transform[] spawnPoints;

    [Header("Character Prefabs")]
    [SerializeField] private GameObject warriorPrefab;
    [SerializeField] private GameObject magePrefab;
    [SerializeField] private GameObject archerPrefab;
    [SerializeField] private GameObject roguePrefab;
    [SerializeField] private GameObject paladinPrefab;

    [Header("UI")]
    [SerializeField] private GameObject nameplatePrefab;

    // Network players
    private Dictionary<string, NetworkPlayer> networkPlayers = new Dictionary<string, NetworkPlayer>();

    // Local player reference
    private GameObject localPlayer;
    private string localPlayerClass;
    private float lastPositionSync = 0f;
    private string lastAnimationState = "Idle";

    void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
        }
        else
        {
            Destroy(gameObject);
        }
    }

    void Start()
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä —Ä–µ–∂–∏–º–µ
        string roomId = PlayerPrefs.GetString("CurrentRoomId", "");
        if (string.IsNullOrEmpty(roomId))
        {
            Debug.Log("[NetworkSync] –ù–µ –≤ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–µ, –æ—Ç–∫–ª—é—á–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é");
            enabled = false;
            return;
        }

        // Subscribe to WebSocket events FIRST
        SubscribeToNetworkEvents();

        // –í–ê–ñ–ù–û: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ –ü–û–°–õ–ï –ø–æ–¥–ø–∏—Å–∫–∏
        // –ü–æ—Ç–æ–º—É —á—Ç–æ –º—ã –º–æ–≥–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ room_players –µ—Å–ª–∏ –æ–Ω–æ –ø—Ä–∏—à–ª–æ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ ArenaScene
        Debug.Log("[NetworkSync] üîÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ...");
        if (SocketIOManager.Instance != null)
        {
            SocketIOManager.Instance.RequestRoomPlayers();
        }
    }


    void Update()
    {
        if (!syncEnabled)
            return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (SocketIOManager.Instance == null || !SocketIOManager.Instance.IsConnected)
            return;

        // Send local player position to server
        if (Time.time - lastPositionSync > positionSyncInterval)
        {
            SyncLocalPlayerPosition();
            SyncLocalPlayerAnimation();  // –í–ê–ñ–ù–û: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            lastPositionSync = Time.time;
        }
    }

    /// <summary>
    /// –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ç–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
    /// </summary>
    private void SubscribeToNetworkEvents()
    {
        if (SocketIOManager.Instance == null)
        {
            Debug.LogError("[NetworkSync] SocketIOManager –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            return;
        }

        // Room players list (when we join)
        SocketIOManager.Instance.On("room_players", OnRoomPlayers);
        SocketIOManager.Instance.On("player_joined", OnPlayerJoined);
        SocketIOManager.Instance.On("player_left", OnPlayerLeft);
        SocketIOManager.Instance.On("player_moved", OnPlayerMoved);
        SocketIOManager.Instance.On("player_animation_changed", OnAnimationChanged); // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: —Ç–µ–ø–µ—Ä—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å–µ—Ä–≤–µ—Ä–æ–º!
        SocketIOManager.Instance.On("player_attacked", OnPlayerAttacked);
        SocketIOManager.Instance.On("player_health_changed", OnHealthChanged);
        SocketIOManager.Instance.On("player_died", OnPlayerDied);
        SocketIOManager.Instance.On("player_respawned", OnPlayerRespawned);

        // Enemy events
        SocketIOManager.Instance.On("enemy_health_changed", OnEnemyHealthChanged);
        SocketIOManager.Instance.On("enemy_damaged_by_server", OnEnemyDamagedByServer);
        SocketIOManager.Instance.On("enemy_died", OnEnemyDied);
        SocketIOManager.Instance.On("enemy_respawned", OnEnemyRespawned);

        Debug.Log("[NetworkSync] ‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Å–µ—Ç–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è");
    }

    /// <summary>
    /// –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    public void SetLocalPlayer(GameObject player, string characterClass)
    {
        localPlayer = player;
        localPlayerClass = characterClass;
        Debug.Log($"[NetworkSync] ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {characterClass}");
        Debug.Log($"[NetworkSync] üîç localPlayer: {(localPlayer != null ? localPlayer.name : "NULL")}");
        Debug.Log($"[NetworkSync] üîç SocketIOManager.Instance: {(SocketIOManager.Instance != null ? "EXISTS" : "NULL")}");
        Debug.Log($"[NetworkSync] üîç SocketIOManager.IsConnected: {(SocketIOManager.Instance != null ? SocketIOManager.Instance.IsConnected.ToString() : "N/A")}");
        Debug.Log($"[NetworkSync] üîç syncEnabled: {syncEnabled}");
    }

    /// <summary>
    /// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void SyncLocalPlayerPosition()
    {
        if (localPlayer == null || SocketIOManager.Instance == null || !SocketIOManager.Instance.IsConnected)
            return;

        // Get velocity –∏ –ø–æ–∑–∏—Ü–∏—é
        Vector3 velocity = Vector3.zero;
        bool isGrounded = true;
        Vector3 position = localPlayer.transform.position;
        Quaternion rotation = localPlayer.transform.rotation;

        var controller = localPlayer.GetComponent<CharacterController>();
        if (controller != null)
        {
            velocity = controller.velocity;
            isGrounded = controller.isGrounded;
        }
        else
        {
            var rigidbody = localPlayer.GetComponent<Rigidbody>();
            if (rigidbody != null)
            {
                velocity = rigidbody.linearVelocity;
            }
        }

        // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é 60-—é –æ—Ç–ø—Ä–∞–≤–∫—É (1 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É –ø—Ä–∏ 20Hz)
        if (Time.frameCount % 60 == 0)
        {
            Debug.Log($"[NetworkSync] üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏: pos=({position.x:F1}, {position.y:F1}, {position.z:F1}), vel=({velocity.x:F1}, {velocity.y:F1}, {velocity.z:F1}), rot={rotation.eulerAngles.y:F0}¬∞");
        }

        // Send to server
        SocketIOManager.Instance.UpdatePosition(position, rotation, velocity, isGrounded);
    }

    /// <summary>
    /// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void SyncLocalPlayerAnimation()
    {
        if (localPlayer == null)
        {
            Debug.LogWarning("[NetworkSync] ‚ö†Ô∏è SyncLocalPlayerAnimation: localPlayer == NULL!");
            return;
        }

        if (SocketIOManager.Instance == null)
        {
            Debug.LogWarning("[NetworkSync] ‚ö†Ô∏è SyncLocalPlayerAnimation: SocketIOManager.Instance == NULL!");
            return;
        }

        if (!SocketIOManager.Instance.IsConnected)
        {
            // –ù–µ —Å–ø–∞–º–∏–º –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
            return;
        }

        string currentState = GetLocalPlayerAnimationState();

        // –í–ê–ñ–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ö–ê–ñ–î–´–ô —Ä–∞–∑ –¥–ª—è real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        // –°–µ—Ä–≤–µ—Ä —Å–∞–º —Ä–µ—à–∏—Ç –Ω—É–∂–Ω–æ –ª–∏ —Ä–∞—Å—Å—ã–ª–∞—Ç—å –≤—Å–µ–º (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)
        bool stateChanged = (currentState != lastAnimationState);

        if (stateChanged)
        {
            Debug.Log($"[NetworkSync] üé¨ –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å: {lastAnimationState} ‚Üí {currentState}");
            lastAnimationState = currentState;
        }

        // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º –ö–ê–ñ–î–£–Æ –æ—Ç–ø—Ä–∞–≤–∫—É –∞–Ω–∏–º–∞—Ü–∏–∏
        Debug.Log($"[NetworkSync] üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: {currentState} (changed={stateChanged})");

        SocketIOManager.Instance.UpdateAnimation(currentState);
    }

    /// <summary>
    /// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private string GetLocalPlayerAnimationState()
    {
        if (localPlayer == null) return "Idle";

        // –í–ê–ñ–ù–û: Animator –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ —Å–∞–º–æ–º –æ–±—ä–µ–∫—Ç–µ –∏–ª–∏ –≤ –¥–æ—á–µ—Ä–Ω–µ–º Model
        var animator = localPlayer.GetComponent<Animator>();
        if (animator == null)
        {
            animator = localPlayer.GetComponentInChildren<Animator>();
        }

        if (animator == null)
        {
            Debug.LogWarning("[NetworkSync] ‚ö†Ô∏è Animator –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞!");
            return "Idle";
        }

        // –í–ê–ñ–ù–û: PlayerController –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Blend Tree —Å MoveX/MoveY/IsMoving
        // –ê –Ω–µ –ø—Ä–æ—Å—Ç—ã–µ bool –ø–∞—Ä–∞–º–µ—Ç—Ä—ã isWalking/isRunning

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∞—Ç–∞–∫—É (—Ç—Ä–∏–≥–≥–µ—Ä)
        if (HasParameter(animator, "isAttacking") && animator.GetBool("isAttacking"))
            return "Attacking";

        if (HasParameter(animator, "isDead") && animator.GetBool("isDead"))
            return "Dead";

        // PlayerController –∏—Å–ø–æ–ª—å–∑—É–µ—Ç IsMoving (bool) –∏ MoveY (float)
        bool isMoving = HasParameter(animator, "IsMoving") && animator.GetBool("IsMoving");

        if (isMoving)
        {
            // MoveY –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å: 0.5 = Walking, 1.0 = Running
            if (HasParameter(animator, "MoveY"))
            {
                float moveY = animator.GetFloat("MoveY");

                // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                if (Time.frameCount % 60 == 0)
                {
                    Debug.Log($"[NetworkSync] üé≠ Animator parameters: IsMoving={isMoving}, MoveY={moveY:F2}");
                }

                // MoveY > 0.7 = Running, –∏–Ω–∞—á–µ Walking
                return moveY > 0.7f ? "Running" : "Walking";
            }
            else
            {
                // Fallback: –µ—Å–ª–∏ –Ω–µ—Ç MoveY, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ Walking
                return "Walking";
            }
        }

        return "Idle";
    }

    /// <summary>
    /// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ Animator
    /// </summary>
    private bool HasParameter(Animator animator, string paramName)
    {
        foreach (AnimatorControllerParameter param in animator.parameters)
        {
            if (param.name == paramName) return true;
        }
        return false;
    }

    // ===== NETWORK EVENT HANDLERS =====

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ (–∫–æ–≥–¥–∞ –º—ã –≤—Ö–æ–¥–∏–º)
    /// </summary>
    private void OnRoomPlayers(string jsonData)
    {
        Debug.Log($"[NetworkSync] üì¶ –ü–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ. JSON: {jsonData}");

        try
        {
            var data = JsonConvert.DeserializeObject<RoomPlayersResponse>(jsonData);

            if (data == null || data.players == null)
            {
                Debug.LogError("[NetworkSync] ‚ùå Failed to parse RoomPlayersResponse");
                return;
            }

            Debug.Log($"[NetworkSync] –í –∫–æ–º–Ω–∞—Ç–µ {data.players.Length} –∏–≥—Ä–æ–∫–æ–≤");
            Debug.Log($"[NetworkSync] –ú–æ–π socketId: {data.yourSocketId}");

            // Spawn all existing players
            foreach (var playerData in data.players)
            {
                Debug.Log($"[NetworkSync] –ò–≥—Ä–æ–∫: {playerData.username} (socketId: {playerData.socketId}, class: {playerData.characterClass})");

                // Skip ourselves
                if (playerData.socketId == data.yourSocketId)
                {
                    Debug.Log($"[NetworkSync] ‚è≠Ô∏è –≠—Ç–æ –º—ã —Å–∞–º–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º");
                    continue;
                }

                // Spawn if not already exists
                if (!networkPlayers.ContainsKey(playerData.socketId))
                {
                    Debug.Log($"[NetworkSync] üé≠ Spawning network player: {playerData.username}");
                    Vector3 pos = new Vector3(playerData.position.x, playerData.position.y, playerData.position.z);
                    SpawnNetworkPlayer(playerData.socketId, playerData.username, playerData.characterClass, pos);
                }
            }

            Debug.Log($"[NetworkSync] üìä –í—Å–µ–≥–æ —Å–µ—Ç–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: {networkPlayers.Count}");
        }
        catch (Exception ex)
        {
            Debug.LogError($"[NetworkSync] ‚ùå Error in OnRoomPlayers: {ex.Message}\n{ex.StackTrace}");
        }
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void OnPlayerJoined(string jsonData)
    {
        var data = JsonConvert.DeserializeObject<PlayerJoinedEvent>(jsonData);
        Debug.Log($"[NetworkSync] –ò–≥—Ä–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è: {data.username} ({data.characterClass})");

        // Don't create network player for ourselves
        // SocketIOManager doesn't have SessionId, so we compare with our socket ID from room_players
        // For now, skip this check - room_players already filters us out

        // Spawn network player
        Vector3 pos = new Vector3(data.position.x, data.position.y, data.position.z);
        SpawnNetworkPlayer(data.socketId, data.username, data.characterClass, pos);
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void OnPlayerLeft(string jsonData)
    {
        var data = JsonConvert.DeserializeObject<PlayerLeftEvent>(jsonData);
        Debug.Log($"[NetworkSync] –ò–≥—Ä–æ–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è: {data.username} ({data.socketId})");

        RemoveNetworkPlayer(data.socketId);
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    /// </summary>
    private void OnPlayerMoved(string jsonData)
    {
        try
        {
            var data = JsonConvert.DeserializeObject<PlayerMovedEvent>(jsonData);

            if (data == null || string.IsNullOrEmpty(data.socketId))
                return;

            if (networkPlayers.TryGetValue(data.socketId, out NetworkPlayer player))
            {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±—ä–µ–∫—Ç –Ω–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω
                if (player == null || player.gameObject == null)
                {
                    networkPlayers.Remove(data.socketId);
                    return;
                }

                Vector3 pos = new Vector3(data.position.x, data.position.y, data.position.z);
                Quaternion rot = Quaternion.Euler(data.rotation.x, data.rotation.y, data.rotation.z);

                // –í–ê–ñ–ù–û: velocity –º–æ–∂–µ—Ç –±—ã—Ç—å null –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª
                Vector3 vel = Vector3.zero;
                if (data.velocity != null)
                {
                    vel = new Vector3(data.velocity.x, data.velocity.y, data.velocity.z);
                }

                float timestamp = data.timestamp > 0 ? (data.timestamp / 1000f) : Time.time;

                player.UpdatePosition(pos, rot, vel, timestamp);
            }
        }
        catch (Exception ex)
        {
            Debug.LogError($"[NetworkSync] ‚ùå Error in OnPlayerMoved: {ex.Message}");
        }
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    /// </summary>
    private void OnAnimationChanged(string jsonData)
    {
        try
        {
            Debug.Log($"[NetworkSync] üì• RAW animation data: {jsonData}");

            var data = JsonConvert.DeserializeObject<AnimationChangedEvent>(jsonData);

            if (data == null)
            {
                Debug.LogError($"[NetworkSync] ‚ùå Failed to deserialize animation data!");
                return;
            }

            Debug.Log($"[NetworkSync] üì• –ü–æ–ª—É—á–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: socketId={data.socketId}, animation={data.animation}");

            // Skip our own updates - server should not send us our own animation

            if (networkPlayers.TryGetValue(data.socketId, out NetworkPlayer player))
            {
                // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±—ä–µ–∫—Ç –Ω–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω
                if (player == null || player.gameObject == null)
                {
                    Debug.LogWarning($"[NetworkSync] ‚ö†Ô∏è Player {data.socketId} is destroyed (animation), removing from dictionary");
                    networkPlayers.Remove(data.socketId);
                    return;
                }

                player.UpdateAnimation(data.animation);
            }
            else
            {
                Debug.LogWarning($"[NetworkSync] ‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞: {data.socketId}");
            }
        }
        catch (Exception ex)
        {
            Debug.LogError($"[NetworkSync] ‚ùå Error in OnAnimationChanged: {ex.Message}\nJSON: {jsonData}");
        }
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞—Ç–∞–∫—É –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void OnPlayerAttacked(string jsonData)
    {
        var data = JsonUtility.FromJson<PlayerAttackedEvent>(jsonData);
        Debug.Log($"[NetworkSync] ‚öîÔ∏è –ê—Ç–∞–∫–∞: {data.socketId}, —Ç–∏–ø: {data.attackType}, —Ü–µ–ª—å: {data.targetType} {data.targetId}");

        // Play attack animation on attacker (if it's a network player)
        if (networkPlayers.TryGetValue(data.socketId, out NetworkPlayer attacker))
        {
            attacker.PlayAttackAnimation(data.attackType);
        }

        // If target is a player and it's us, apply damage
        // Note: We need to track our socket ID from room_players event
        // For now, server handles damage logic
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è –∏–≥—Ä–æ–∫–∞ (SERVER AUTHORITY)
    /// </summary>
    private void OnHealthChanged(string jsonData)
    {
        var data = JsonUtility.FromJson<HealthChangedEvent>(jsonData);
        string critText = data.isCritical ? " üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–î–ê–†!" : "";
        Debug.Log($"[NetworkSync] üíî –ó–¥–æ—Ä–æ–≤—å–µ –∏–≥—Ä–æ–∫–∞ {data.socketId}: {data.currentHealth}/{data.maxHealth}{critText}");

        if (networkPlayers.TryGetValue(data.socketId, out NetworkPlayer player))
        {
            player.ShowDamage(data.damage);
            // TODO: Update health bar
        }

        // TODO: –ï—Å–ª–∏ —ç—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏ —É—Ä–æ–Ω, –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∏–≥—Ä–æ–∫—É
        // –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–º–µ—Ä—Ç—å –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void OnPlayerDied(string jsonData)
    {
        var data = JsonUtility.FromJson<PlayerDiedEvent>(jsonData);
        Debug.Log($"[NetworkSync] ‚ò†Ô∏è –ò–≥—Ä–æ–∫ –ø–æ–≥–∏–±: {data.socketId}, –£–±–∏–π—Ü–∞: {data.killerId}");

        // Check if it's a network player
        if (networkPlayers.TryGetValue(data.socketId, out NetworkPlayer player))
        {
            // Play death animation
            player.UpdateAnimation("Dead");
        }
        // If not in networkPlayers, it might be us - handle in HealthSystem
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ—Å–ø–∞–≤–Ω –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void OnPlayerRespawned(string jsonData)
    {
        var data = JsonUtility.FromJson<PlayerRespawnedEvent>(jsonData);
        Debug.Log($"[NetworkSync] üîÑ –ò–≥—Ä–æ–∫ –≤–æ–∑—Ä–æ–¥–∏–ª—Å—è: {data.socketId}");

        if (networkPlayers.TryGetValue(data.socketId, out NetworkPlayer player))
        {
            Vector3 spawnPos = new Vector3(data.position.x, data.position.y, data.position.z);
            player.OnRespawn(spawnPos);
        }
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è –≤—Ä–∞–≥–∞
    /// </summary>
    private void OnEnemyHealthChanged(string jsonData)
    {
        var data = JsonUtility.FromJson<EnemyHealthChangedEvent>(jsonData);
        Debug.Log($"[NetworkSync] üê∫ –í—Ä–∞–≥ {data.enemyId} –ø–æ–ª—É—á–∏–ª —É—Ä–æ–Ω: {data.damage}, –∑–¥–æ—Ä–æ–≤—å–µ: {data.currentHealth}");

        // TODO: Find enemy by ID and update its health
        // This will be implemented when we have enemy manager
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —É—Ä–æ–Ω –≤—Ä–∞–≥–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (SERVER AUTHORITY)
    /// –°–µ—Ä–≤–µ—Ä —Ä–∞—Å—Å—á–∏—Ç–∞–ª —É—Ä–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ SPECIAL —Å—Ç–∞—Ç–æ–≤ –∞—Ç–∞–∫—É—é—â–µ–≥–æ
    /// </summary>
    private void OnEnemyDamagedByServer(string jsonData)
    {
        var data = JsonUtility.FromJson<EnemyDamagedByServerEvent>(jsonData);
        Debug.Log($"[NetworkSync] üéØ –°–µ—Ä–≤–µ—Ä –Ω–∞–Ω—ë—Å —É—Ä–æ–Ω –≤—Ä–∞–≥—É {data.enemyId}: {data.damage} —É—Ä–æ–Ω–∞{(data.isCritical ? " (–ö–†–ò–¢!)" : "")}");

        // –ù–∞–π—Ç–∏ –≤—Ä–∞–≥–∞ –ø–æ ID –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —É—Ä–æ–Ω
        GameObject[] enemies = GameObject.FindGameObjectsWithTag("Enemy");
        foreach (GameObject enemyObj in enemies)
        {
            Enemy enemy = enemyObj.GetComponent<Enemy>();
            if (enemy != null && enemy.GetEnemyId() == data.enemyId)
            {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —É—Ä–æ–Ω –∫ –≤—Ä–∞–≥—É
                enemy.TakeDamage(data.damage);
                Debug.Log($"[NetworkSync] ‚úÖ –ü—Ä–∏–º–µ–Ω—ë–Ω —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —É—Ä–æ–Ω –∫ {enemy.GetEnemyName()}: {data.damage}{(data.isCritical ? " –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô" : "")}");
                return;
            }
        }

        Debug.LogWarning($"[NetworkSync] ‚ö†Ô∏è –í—Ä–∞–≥ {data.enemyId} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —É—Ä–æ–Ω–∞");
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–º–µ—Ä—Ç—å –≤—Ä–∞–≥–∞
    /// </summary>
    private void OnEnemyDied(string jsonData)
    {
        var data = JsonUtility.FromJson<EnemyDiedEvent>(jsonData);
        Debug.Log($"[NetworkSync] üíÄ –í—Ä–∞–≥ {data.enemyId} —É–±–∏—Ç –∏–≥—Ä–æ–∫–æ–º {data.killerUsername}");

        // TODO: Find enemy by ID and play death animation
        // This will be implemented when we have enemy manager
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ—Å–ø–∞–≤–Ω –≤—Ä–∞–≥–∞
    /// </summary>
    private void OnEnemyRespawned(string jsonData)
    {
        var data = JsonUtility.FromJson<EnemyRespawnedEvent>(jsonData);
        Debug.Log($"[NetworkSync] üîÑ –í—Ä–∞–≥ {data.enemyId} ({data.enemyType}) –≤–æ–∑—Ä–æ–¥–∏–ª—Å—è");

        // TODO: Respawn enemy at position
        // This will be implemented when we have enemy manager
    }


    // ===== NETWORK PLAYER MANAGEMENT =====

    /// <summary>
    /// –°–æ–∑–¥–∞—Ç—å —Å–µ—Ç–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void SpawnNetworkPlayer(string socketId, string username, string characterClass, Vector3 position)
    {
        GameObject prefab = GetCharacterPrefab(characterClass);
        if (prefab == null)
        {
            Debug.LogError($"[NetworkSync] –ü—Ä–µ—Ñ–∞–± –¥–ª—è –∫–ª–∞—Å—Å–∞ {characterClass} –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            return;
        }

        GameObject playerObj = Instantiate(prefab, position, Quaternion.identity);
        playerObj.name = $"NetworkPlayer_{username}";
        playerObj.layer = LayerMask.NameToLayer("Character");

        // –í–ê–ñ–ù–û: –ù–∞–π—Ç–∏ –º–æ–¥–µ–ª—å –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ—Ñ–∞–±–∞
        Transform modelTransform = playerObj.transform.Find("Model") ?? playerObj.transform;

        // –í–ê–ñ–ù–û: –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        // –ò—â–µ–º PlayerController –Ω–∞ –í–°–ï–• —É—Ä–æ–≤–Ω—è—Ö (root, model, children)
        PlayerController[] allPlayerControllers = playerObj.GetComponentsInChildren<PlayerController>(true);
        foreach (var pc in allPlayerControllers)
        {
            pc.enabled = false;
            Debug.Log($"[NetworkSync] ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω PlayerController –Ω–∞ {pc.gameObject.name} –¥–ª—è {username}");
        }

        // –û—Ç–∫–ª—é—á–∞–µ–º PlayerAttack —á—Ç–æ–±—ã NetworkPlayer –Ω–µ –∞—Ç–∞–∫–æ–≤–∞–ª –ª–æ–∫–∞–ª—å–Ω–æ
        PlayerAttack[] allPlayerAttacks = playerObj.GetComponentsInChildren<PlayerAttack>(true);
        foreach (var pa in allPlayerAttacks)
        {
            pa.enabled = false;
            Debug.Log($"[NetworkSync] ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω PlayerAttack –Ω–∞ {pa.gameObject.name} –¥–ª—è {username}");
        }

        // –û—Ç–∫–ª—é—á–∞–µ–º TargetSystem —á—Ç–æ–±—ã NetworkPlayer –Ω–µ —Ç–∞—Ä–≥–µ—Ç–∏–ª
        TargetSystem[] allTargetSystems = playerObj.GetComponentsInChildren<TargetSystem>(true);
        foreach (var ts in allTargetSystems)
        {
            ts.enabled = false;
            Debug.Log($"[NetworkSync] ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω TargetSystem –Ω–∞ {ts.gameObject.name} –¥–ª—è {username}");
        }

        // –û—Ç–∫–ª—é—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ input –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        var cameraController = playerObj.GetComponentInChildren<Camera>();
        if (cameraController != null)
        {
            cameraController.gameObject.SetActive(false);
            Debug.Log($"[NetworkSync] ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω–∞ –∫–∞–º–µ—Ä–∞ –¥–ª—è {username}");
        }

        // –û—Ç–∫–ª—é—á–∞–µ–º CharacterController (NetworkPlayer —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ NetworkTransform)
        CharacterController[] allCharControllers = playerObj.GetComponentsInChildren<CharacterController>(true);
        foreach (var cc in allCharControllers)
        {
            cc.enabled = false;
            Debug.Log($"[NetworkSync] ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω CharacterController –Ω–∞ {cc.gameObject.name} –¥–ª—è {username}");
        }

        // –í–ê–ñ–ù–û: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ä—É–∂–∏–µ –∏–∑ WeaponDatabase
        SetupNetworkPlayerWeapon(modelTransform, characterClass);

        // Add NetworkPlayer component
        NetworkPlayer networkPlayer = playerObj.AddComponent<NetworkPlayer>();
        networkPlayer.socketId = socketId;
        networkPlayer.username = username;
        networkPlayer.characterClass = characterClass;

        // Set nameplate prefab
        if (nameplatePrefab != null)
        {
            // Assign via reflection or make it public
            var field = typeof(NetworkPlayer).GetField("nameplatePrefab", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            field?.SetValue(networkPlayer, nameplatePrefab);
        }

        // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç Enemy –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞ –∏ —Ç—É–º–∞–Ω–∞ –≤–æ–π–Ω—ã
        SetupNetworkPlayerAsEnemy(playerObj, username);

        networkPlayers[socketId] = networkPlayer;

        Debug.Log($"[NetworkSync] ‚úÖ –°–æ–∑–¥–∞–Ω —Å–µ—Ç–µ–≤–æ–π –∏–≥—Ä–æ–∫: {username} ({characterClass}) - –≤—Ä–∞–≥ –¥–ª—è —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞");
    }

    /// <summary>
    /// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ä—É–∂–∏–µ –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void SetupNetworkPlayerWeapon(Transform modelTransform, string characterClass)
    {
        // –ù–∞–π—Ç–∏ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å ClassWeaponManager
        var weaponManager = modelTransform.GetComponent<ClassWeaponManager>();
        if (weaponManager == null)
        {
            weaponManager = modelTransform.gameObject.AddComponent<ClassWeaponManager>();
            Debug.Log($"[NetworkSync] –î–æ–±–∞–≤–ª–µ–Ω ClassWeaponManager –¥–ª—è {characterClass}");
        }

        // –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –ª–æ–≥–æ–≤
        var characterClassEnum = (CharacterClass)System.Enum.Parse(typeof(CharacterClass), characterClass);
        weaponManager.SetCharacterClass(characterClassEnum);
        Debug.Log($"[NetworkSync] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–ª–∞—Å—Å {characterClass} –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞");

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å WeaponDatabase
        var weaponDatabase = Resources.Load<WeaponDatabase>("WeaponDatabase");
        if (weaponDatabase != null)
        {
            // –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –∏–ª–∏ –¥–µ–ª–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–º
            var method = typeof(ClassWeaponManager).GetMethod("AttachWeaponForClass", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
            if (method != null)
            {
                method.Invoke(weaponManager, null);
                Debug.Log($"[NetworkSync] ‚úÖ –û—Ä—É–∂–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –¥–ª—è {characterClass}");
            }
            else
            {
                Debug.LogWarning($"[NetworkSync] ‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –º–µ—Ç–æ–¥ AttachWeaponForClass");
            }
        }
        else
        {
            Debug.LogWarning($"[NetworkSync] ‚ö†Ô∏è WeaponDatabase –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Resources");
        }
    }

    /// <summary>
    /// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ç–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∫–∞–∫ Enemy (–¥–ª—è —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞ –∏ —Ç—É–º–∞–Ω–∞ –≤–æ–π–Ω—ã)
    /// </summary>
    private void SetupNetworkPlayerAsEnemy(GameObject playerObj, string username)
    {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç Enemy
        Enemy enemyComponent = playerObj.AddComponent<Enemy>();

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º reflection –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–ª–µ–π
        var enemyNameField = typeof(Enemy).GetField("enemyName", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        if (enemyNameField != null)
        {
            enemyNameField.SetValue(enemyComponent, username);
        }

        var maxHealthField = typeof(Enemy).GetField("maxHealth", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        if (maxHealthField != null)
        {
            maxHealthField.SetValue(enemyComponent, 10000f); // –û–ß–ï–ù–¨ –í–´–°–û–ö–û–ï HP - —Å–µ—Ç–µ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ –±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–µ
        }

        // –í–ê–ñ–ù–û: –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å currentHealth —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ HP
        var currentHealthField = typeof(Enemy).GetField("currentHealth", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
        if (currentHealthField != null)
        {
            currentHealthField.SetValue(enemyComponent, 10000f); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º currentHealth = maxHealth
            Debug.Log($"[NetworkSync] ‚úÖ currentHealth —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: 10000");
        }

        // –í–ê–ñ–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º Enemy –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —á—Ç–æ–±—ã –æ–Ω –Ω–µ –≤—ã–∑—ã–≤–∞–ª TakeDamage/Die
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ FogOfWar
        enemyComponent.enabled = false;
        Debug.Log($"[NetworkSync] ‚ö†Ô∏è Enemy –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –û–¢–ö–õ–Æ–ß–Å–ù (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞)");

        // –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–≥ "Enemy" –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞
        if (!playerObj.CompareTag("Enemy"))
        {
            try
            {
                playerObj.tag = "Enemy";
                Debug.Log($"[NetworkSync] ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–µ–≥ 'Enemy' –¥–ª—è {username}");
            }
            catch (UnityException ex)
            {
                Debug.LogError($"[NetworkSync] ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–≥ 'Enemy': {ex.Message}. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–≥ 'Enemy' –≤ Project Settings ‚Üí Tags and Layers!");
            }
        }

        // –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ FogOfWar —Å–∏—Å—Ç–µ–º–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        if (localPlayer != null)
        {
            FogOfWar fogOfWar = localPlayer.GetComponent<FogOfWar>();
            if (fogOfWar != null)
            {
                fogOfWar.RegisterEnemy(enemyComponent);
                Debug.Log($"[NetworkSync] ‚úÖ –°–µ—Ç–µ–≤–æ–π –∏–≥—Ä–æ–∫ {username} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ FogOfWar");
            }
        }

        Debug.Log($"[NetworkSync] ‚úÖ –°–µ—Ç–µ–≤–æ–π –∏–≥—Ä–æ–∫ {username} –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ Enemy (–º–æ–∂–Ω–æ —Ç–∞—Ä–≥–µ—Ç–∏—Ç—å)");
    }

    /// <summary>
    /// –£–¥–∞–ª–∏—Ç—å —Å–µ—Ç–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void RemoveNetworkPlayer(string socketId)
    {
        if (networkPlayers.TryGetValue(socketId, out NetworkPlayer player))
        {
            // –û—Ç—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏–∑ FogOfWar –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
            Enemy enemyComponent = player.GetComponent<Enemy>();
            if (enemyComponent != null && localPlayer != null)
            {
                FogOfWar fogOfWar = localPlayer.GetComponent<FogOfWar>();
                if (fogOfWar != null)
                {
                    fogOfWar.UnregisterEnemy(enemyComponent);
                }
            }

            Destroy(player.gameObject);
            networkPlayers.Remove(socketId);
            Debug.Log($"[NetworkSync] –£–¥–∞–ª–µ–Ω —Å–µ—Ç–µ–≤–æ–π –∏–≥—Ä–æ–∫: {socketId}");
        }
    }

    /// <summary>
    /// –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ—Ñ–∞–± –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ –∫–ª–∞—Å—Å—É
    /// </summary>
    private GameObject GetCharacterPrefab(string characterClass)
    {
        switch (characterClass)
        {
            case "Warrior": return warriorPrefab;
            case "Mage": return magePrefab;
            case "Archer": return archerPrefab;
            case "Rogue": return roguePrefab;
            case "Paladin": return paladinPrefab;
            default:
                Debug.LogWarning($"[NetworkSync] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∞—Å—Å: {characterClass}");
                return warriorPrefab; // Fallback
        }
    }

    /// <summary>
    /// –ü—Ä–∏–º–µ–Ω–∏—Ç—å —É—Ä–æ–Ω –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∏–≥—Ä–æ–∫—É
    /// </summary>
    private void ApplyDamageToLocalPlayer(float damage)
    {
        if (localPlayer == null) return;

        var healthSystem = localPlayer.GetComponent<HealthSystem>();
        if (healthSystem != null)
        {
            healthSystem.TakeDamage((int)damage);
            Debug.Log($"[NetworkSync] –ü–æ–ª—É—á–∏–ª–∏ —É—Ä–æ–Ω: {damage}");
        }
    }

    /// <summary>
    /// –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–º–µ—Ä—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    /// </summary>
    private void OnLocalPlayerDied()
    {
        Debug.Log("[NetworkSync] –ú—ã –ø–æ–≥–∏–±–ª–∏!");

        // TODO: Show death screen, respawn button
        // For now, auto-respawn after 5 seconds
        Invoke(nameof(RequestRespawn), 5f);
    }

    /// <summary>
    /// –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–µ—Å–ø–∞–≤–Ω
    /// </summary>
    private void RequestRespawn()
    {
        if (localPlayer != null && spawnPoints != null && spawnPoints.Length > 0)
        {
            // Choose random spawn point
            Transform spawnPoint = spawnPoints[UnityEngine.Random.Range(0, spawnPoints.Length)];
            Vector3 spawnPos = spawnPoint != null ? spawnPoint.position : Vector3.zero;

            // TODO: Add SendRespawn method to SocketIOManager
            // SocketIOManager.Instance.SendRespawn(spawnPos);
            Debug.LogWarning("[NetworkSync] SendRespawn not yet implemented in SocketIOManager");
        }
    }

    /// <summary>
    /// –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ—Ö —Å–µ—Ç–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ (–ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã)
    /// </summary>
    public void ClearAllNetworkPlayers()
    {
        foreach (var player in networkPlayers.Values)
        {
            if (player != null)
            {
                Destroy(player.gameObject);
            }
        }
        networkPlayers.Clear();
        Debug.Log("[NetworkSync] –í—Å–µ —Å–µ—Ç–µ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ —É–¥–∞–ª–µ–Ω—ã");
    }

    void OnDestroy()
    {
        // Note: SocketIOManager handles event cleanup internally
        // We don't need to manually unsubscribe
        Debug.Log("[NetworkSync] NetworkSyncManager destroyed");
    }
}

// ===== EVENT DATA CLASSES (matching multiplayer.js server) =====

/// <summary>
/// Response when joining a room (room_players event)
/// </summary>
[Serializable]
public class RoomPlayersResponse
{
    public RoomPlayerInfo[] players;
    public string yourSocketId;
}

[Serializable]
public class RoomPlayerInfo
{
    public string socketId;
    public string username;
    public string characterClass;
    public Vector3Data position;
    public Vector3Data rotation;
    public string animation;
    public float health;
    public float maxHealth;
}

/// <summary>
/// Player joined event
/// </summary>
[Serializable]
public class PlayerJoinedEvent
{
    public string socketId;
    public string username;
    public string characterClass;
    public Vector3Data position;
    public Vector3Data rotation;
}

/// <summary>
/// Player left event
/// </summary>
[Serializable]
public class PlayerLeftEvent
{
    public string socketId;
    public string username;
}

/// <summary>
/// Player moved event
/// </summary>
[Serializable]
public class PlayerMovedEvent
{
    public string socketId;
    public Vector3Data position;
    public Vector3Data rotation;
    public Vector3Data velocity;
    public bool isGrounded;
    public long timestamp;
}

/// <summary>
/// Animation changed event
/// </summary>
[Serializable]
public class AnimationChangedEvent
{
    public string socketId;
    public string animation;
    public float speed;
    public long timestamp;
}

/// <summary>
/// Player attacked event
/// </summary>
[Serializable]
public class PlayerAttackedEvent
{
    public string socketId;
    public string attackType;
    public string targetType;
    public string targetId;
    public float damage;
    public Vector3Data position;
    public Vector3Data direction;
    public int skillId;
    public long timestamp;
}

/// <summary>
/// Player health changed event
/// </summary>
[Serializable]
public class HealthChangedEvent
{
    public string socketId;
    public float damage;
    public float currentHealth;
    public float maxHealth;
    public string attackerId;
    public bool isCritical;
    public long timestamp;
}

/// <summary>
/// Player died event
/// </summary>
[Serializable]
public class PlayerDiedEvent
{
    public string socketId;
    public string killerId;
    public long timestamp;
}

/// <summary>
/// Player respawned event
/// </summary>
[Serializable]
public class PlayerRespawnedEvent
{
    public string socketId;
    public Vector3Data position;
    public float health;
    public long timestamp;
}

/// <summary>
/// Enemy health changed event
/// </summary>
[Serializable]
public class EnemyHealthChangedEvent
{
    public string enemyId;
    public float damage;
    public float currentHealth;
    public string attackerId;
    public long timestamp;
}

/// <summary>
/// Enemy damaged by server event (SERVER AUTHORITY)
/// </summary>
[Serializable]
public class EnemyDamagedByServerEvent
{
    public string enemyId;
    public float damage;
    public string attackerId;
    public string attackerUsername;
    public bool isCritical;
    public long timestamp;
}

/// <summary>
/// Enemy died event
/// </summary>
[Serializable]
public class EnemyDiedEvent
{
    public string enemyId;
    public string killerId;
    public string killerUsername;
    public Vector3Data position;
    public long timestamp;
}

/// <summary>
/// Enemy respawned event
/// </summary>
[Serializable]
public class EnemyRespawnedEvent
{
    public string enemyId;
    public string enemyType;
    public Vector3Data position;
    public float health;
    public long timestamp;
}

/// <summary>
/// Vector3 serializable for JSON
/// </summary>
[Serializable]
public class Vector3Data
{
    public float x;
    public float y;
    public float z;
}
