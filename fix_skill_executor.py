#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è SkillExecutor –≤ ArenaManager.cs
"""

import re

# –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
with open('Assets/Scripts/Arena/ArenaManager.cs', 'r', encoding='utf-8') as f:
    content = f.read()

# –ò—â–µ–º –∏ –∑–∞–º–µ–Ω—è–µ–º –±–ª–æ–∫ –∫–æ–¥–∞
old_code = """        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –æ—á–∫–æ–≤ –¥–µ–π—Å—Ç–≤–∏—è
        ActionPointsSystem actionPointsSystem = modelTransform.GetComponent<ActionPointsSystem>();
        if (actionPointsSystem == null)
        {
            actionPointsSystem = modelTransform.gameObject.AddComponent<ActionPointsSystem>();
            Debug.Log("‚úì –î–æ–±–∞–≤–ª–µ–Ω ActionPointsSystem");
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É —Å–∫–∏–ª–ª–æ–≤ (–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï!)
        SkillManager skillManager = modelTransform.GetComponent<SkillManager>();
        if (skillManager == null)
        {
            skillManager = modelTransform.gameObject.AddComponent<SkillManager>();
            Debug.Log("‚úì –î–æ–±–∞–≤–ª–µ–Ω SkillManager");
        }

        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫–∏–ª–ª—ã –∏–∑ SkillDatabase –¥–ª—è –∫–ª–∞—Å—Å–∞
        LoadSkillsForClass(skillManager);

        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫–∏–ª–ª—ã –∏–∑ PlayerPrefs
        LoadEquippedSkillsFromPlayerPrefs(skillManager);"""

new_code = """        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –æ—á–∫–æ–≤ –¥–µ–π—Å—Ç–≤–∏—è
        ActionPointsSystem actionPointsSystem = modelTransform.GetComponent<ActionPointsSystem>();
        if (actionPointsSystem == null)
        {
            actionPointsSystem = modelTransform.gameObject.AddComponent<ActionPointsSystem>();
            Debug.Log("‚úì –î–æ–±–∞–≤–ª–µ–Ω ActionPointsSystem");
        }

        // –°–ò–°–¢–ï–ú–ê –°–ö–ò–õ–õ–û–í: EffectManager + SkillExecutor + SkillManager

        // 1. –î–æ–±–∞–≤–ª—è–µ–º EffectManager (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏: Root, Stun, Slow –∏ —Ç.–¥.)
        EffectManager effectManager = modelTransform.GetComponent<EffectManager>();
        if (effectManager == null)
        {
            effectManager = modelTransform.gameObject.AddComponent<EffectManager>();
            Debug.Log("‚úì –î–æ–±–∞–≤–ª–µ–Ω EffectManager");
        }

        // 2. –î–æ–±–∞–≤–ª—è–µ–º SkillExecutor (–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï! –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–ï–î SkillManager)
        SkillExecutor skillExecutor = modelTransform.GetComponent<SkillExecutor>();
        if (skillExecutor == null)
        {
            skillExecutor = modelTransform.gameObject.AddComponent<SkillExecutor>();
            Debug.Log("‚úì –î–æ–±–∞–≤–ª–µ–Ω SkillExecutor");
        }

        // 3. –î–æ–±–∞–≤–ª—è–µ–º SkillManager (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º —Å–∫–∏–ª–ª–æ–≤)
        SkillManager skillManager = modelTransform.GetComponent<SkillManager>();
        if (skillManager == null)
        {
            skillManager = modelTransform.gameObject.AddComponent<SkillManager>();
            Debug.Log("‚úì –î–æ–±–∞–≤–ª–µ–Ω SkillManager");
        }

        // 4. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –∏–∑ Resources/Skills/ –ø–æ –∫–ª–∞—Å—Å—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        string selectedClass = PlayerPrefs.GetString("SelectedCharacterClass", "Warrior");
        Debug.Log($"[ArenaManager] üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∏–ª–ª–æ–≤ –¥–ª—è –∫–ª–∞—Å—Å–∞ {selectedClass} –∏–∑ Resources/Skills/...");
        LoadAllSkillsToManager(skillManager, selectedClass);"""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–ª–æ–∫ –Ω–∞–π–¥–µ–Ω
if old_code in content:
    print("‚úÖ –ù–∞–π–¥–µ–Ω –±–ª–æ–∫ –¥–ª—è –∑–∞–º–µ–Ω—ã")
    content = content.replace(old_code, new_code)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    with open('Assets/Scripts/Arena/ArenaManager.cs', 'w', encoding='utf-8') as f:
        f.write(content)

    print("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!")
    print("\nüìù –ò–∑–º–µ–Ω–µ–Ω–∏—è:")
    print("  - –î–æ–±–∞–≤–ª–µ–Ω EffectManager")
    print("  - –î–æ–±–∞–≤–ª–µ–Ω SkillExecutor (–ø–µ—Ä–µ–¥ SkillManager)")
    print("  - –£–±—Ä–∞–Ω—ã LoadSkillsForClass –∏ LoadEquippedSkillsFromPlayerPrefs")
    print("  - –î–æ–±–∞–≤–ª–µ–Ω LoadAllSkillsToManager —Å –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–æ–π –∏–∑ Resources/Skills/")
else:
    print("‚ùå –ë–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω! –í–æ–∑–º–æ–∂–Ω–æ —Ñ–∞–π–ª —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω.")
