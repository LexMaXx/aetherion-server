# üîß Server Room API Fix - Deployment Guide

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫–∏:
- **HTTP 500 Internal Server Error** - –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–º–Ω–∞—Ç—É
- **HTTP 400 Bad Request** - –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã

## –ü—Ä–∏—á–∏–Ω–∞
JWT —Ç–æ–∫–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `req.user.id` –∫–∞–∫ **string**, –Ω–æ MongoDB –º–æ–¥–µ–ª—å Room –æ–∂–∏–¥–∞–µ—Ç `userId` –∫–∞–∫ **ObjectId**. –≠—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
–û–±–Ω–æ–≤–ª–µ–Ω —Ñ–∞–π–ª `SERVER_CODE/routes/room.js`:

### 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç mongoose
```javascript
const mongoose = require('mongoose'); // –î–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ userId –≤ ObjectId
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ route handlers –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ userId

#### `/api/room/create`
```javascript
const userIdStr = req.user.id; // –ò–∑ JWT —Ç–æ–∫–µ–Ω–∞ (string)
const userId = mongoose.Types.ObjectId(userIdStr); // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ ObjectId
```

#### `/api/room/join`
```javascript
const userIdStr = req.user.id;
const userId = mongoose.Types.ObjectId(userIdStr);
```

#### `/api/room/leave`
```javascript
const userIdStr = req.user.id;
const userId = mongoose.Types.ObjectId(userIdStr);
```

#### `/api/room/start`
```javascript
const userIdStr = req.user.id;
const userId = mongoose.Types.ObjectId(userIdStr);
```

## –ö–∞–∫ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ Render.com

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Git Push (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```bash
cd c:/Users/Asus/Aetherion
git add SERVER_CODE/routes/room.js
git commit -m "Fix: Convert userId from JWT string to ObjectId in room routes

- Fixed HTTP 500 error when joining rooms
- Fixed HTTP 400 error when creating rooms
- Added mongoose import for ObjectId conversion
- Updated all room route handlers (create, join, leave, start)"
git push origin main
```

2. **Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
   - –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://dashboard.render.com
   - –ù–∞–π–¥–∏—Ç–µ –≤–∞—à —Å–µ—Ä–≤–∏—Å "aetherion-server"
   - –î–æ–∂–¥–∏—Ç–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è (–æ–±—ã—á–Ω–æ 2-5 –º–∏–Ω—É—Ç)
   - –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "Live"

### –í–∞—Ä–∏–∞–Ω—Ç 2: Manual Deploy

–ï—Å–ª–∏ –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:

1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://dashboard.render.com
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —Å–µ—Ä–≤–∏—Å "aetherion-server"
3. –ù–∞–∂–º–∏—Ç–µ **"Manual Deploy"** ‚Üí **"Deploy latest commit"**
4. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∏–∫—Å —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint
```bash
curl https://aetherion-server-gv5u.onrender.com/health
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
```json
{
  "status": "healthy",
  "mongodb": "connected"
}
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Unity –∏–≥—Ä—É –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è / –í–æ–π—Ç–∏
2. –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
3. **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É** - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫ 400
4. **–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É** - –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫ 500
5. –ó–∞–≥—Ä—É–∑–∏—Ç—å ArenaScene

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
–ù–∞ Render.com dashboard ‚Üí Logs, –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
```
[Room] Created: <room-id> by <username>
[Room] <username> joined room <room-id>
```

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –µ—Å—Ç—å –æ—à–∏–±–∫–∏

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é Mongoose
–í `SERVER_CODE/package.json` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```json
"mongoose": "^7.0.0"
```

–ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è < 6.0, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
```javascript
const userId = new mongoose.Types.ObjectId(userIdStr);
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT payload
JWT —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å `id` –ø–æ–ª–µ:
```javascript
// –í auth middleware –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
const decoded = jwt.verify(token, process.env.JWT_SECRET);
// decoded.id –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Unity
–í Unity Console –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏:
```
[RoomManager] Create room request: {"roomName":"...","characterClass":"Warrior",...}
[RoomManager] ‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ... (ID: ...)
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
```
[RoomManager] ‚ùå HTTP –æ—à–∏–±–∫–∞: ...
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ response body –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–∏.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –î–æ–±–∞–≤–∏—Ç—å error handling –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ ObjectId
```javascript
try {
    const userId = mongoose.Types.ObjectId(userIdStr);
} catch (error) {
    return res.status(400).json({
        success: false,
        message: 'Invalid user ID format'
    });
}
```

### –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–µ–±–∞–≥–∞
```javascript
console.log(`[Room] User ${userId} attempting to create room`);
```

## –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç mongoose
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω POST /api/room/create
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω POST /api/room/join
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω POST /api/room/leave
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω POST /api/room/start
‚è≥ –û–∂–∏–¥–∞–µ—Ç –¥–µ–ø–ª–æ—è –Ω–∞ Render.com
‚è≥ –û–∂–∏–¥–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Unity

---

**–î–∞—Ç–∞:** 2025-10-12
**–í–µ—Ä—Å–∏—è:** 2.0.1
**–ê–≤—Ç–æ—Ä:** Claude Code Assistant
