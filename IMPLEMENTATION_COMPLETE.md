# ‚úÖ –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–õ–ù–û–ô –°–ï–†–í–ï–†–ù–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò

## üéâ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (Node.js + Socket.IO)

1. **multiplayer.js** - –ü–æ–ª–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Socket.IO —Å–æ–±—ã—Ç–∏–π
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏—è (10 Hz)
   - –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
   - –ê—Ç–∞–∫–∏ –∏ —É—Ä–æ–Ω
   - –°–º–µ—Ä—Ç—å –∏ —Ä–µ—Å–ø–∞–≤–Ω
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–∞–≥–æ–≤ (NPC)
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ –ø–∞–º—è—Ç–∏

2. **server_with_socketio.js** - –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Socket.IO —Å Express
   - CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Unity
   - WebSocket + polling —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ multiplayer.js

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å (Unity)

1. **SocketIOClient.cs** - –ù–æ–≤—ã–π Socket.IO –∫–ª–∏–µ–Ω—Ç
   ```csharp
   // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
   - Connect(token, callback) - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
   - JoinRoom(roomId, characterClass, callback) - –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
   - UpdatePosition(pos, rot, velocity, isGrounded) - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
   - SendAnimation(animation, speed) - –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
   - SendAttack(targetType, targetId, damage) - –ê—Ç–∞–∫–∞
   - SendDamage(damage, currentHealth, attackerId) - –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞
   - SendRespawn(position) - –†–µ—Å–ø–∞–≤–Ω
   - SendEnemyDamaged/Killed() - –°–æ–±—ã—Ç–∏—è –≤—Ä–∞–≥–æ–≤
   ```

2. **NetworkSyncManager.cs** - –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è Socket.IO
   ```csharp
   // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:
   - room_players - –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ
   - player_joined - –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è
   - player_left - –ò–≥—Ä–æ–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è
   - player_moved - –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
   - player_animation_changed - –°–º–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
   - player_attacked - –ê—Ç–∞–∫–∞
   - player_health_changed - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è
   - player_died - –°–º–µ—Ä—Ç—å
   - player_respawned - –†–µ—Å–ø–∞–≤–Ω
   - enemy_health_changed/died/respawned - –°–æ–±—ã—Ç–∏—è –≤—Ä–∞–≥–æ–≤
   ```

3. **RoomManager.cs** - –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è Socket.IO
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SocketIOClient –≤–º–µ—Å—Ç–æ SimpleWebSocketClient
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ —á–µ—Ä–µ–∑ Socket.IO
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ

### Data Classes (Serializable)

–í—Å–µ –∫–ª–∞—Å—Å—ã –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å multiplayer.js:

```csharp
// Request classes (Unity ‚Üí Server):
- JoinRoomRequest
- PlayerUpdateRequest
- AnimationRequest
- AttackRequest
- DamageRequest
- RespawnRequest
- EnemyDamagedRequest
- EnemyKilledRequest

// Response classes (Server ‚Üí Unity):
- RoomPlayersResponse
- PlayerJoinedEvent
- PlayerLeftEvent
- PlayerMovedEvent
- AnimationChangedEvent
- PlayerAttackedEvent
- HealthChangedEvent
- PlayerDiedEvent
- PlayerRespawnedEvent
- EnemyHealthChangedEvent
- EnemyDiedEvent
- EnemyRespawnedEvent
```

---

## üîÑ –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ

```
–ò–≥—Ä–æ–∫ ‚Üí Login ‚Üí Character Selection ‚Üí Room Selection
                                            ‚Üì
                                    RoomManager.JoinRoom()
                                            ‚Üì
                                    REST API (—Å–æ–∑–¥–∞–Ω–∏–µ/–≤—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É)
                                            ‚Üì
                                    SocketIOClient.Connect()
                                            ‚Üì
                                    SocketIOClient.JoinRoom()
                                            ‚Üì
                                    –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç room_players
                                            ‚Üì
                                    NetworkSyncManager —Å–ø–∞–≤–Ω–∏—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                                            ‚Üì
                                    LoadArenaScene ‚Üí –ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!
```

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏

```
–ö–∞–∂–¥—ã–µ 0.1 —Å–µ–∫:
Unity ‚Üí SocketIOClient.UpdatePosition() ‚Üí Emit "player_update"
                                                ‚Üì
                                        Server (multiplayer.js)
                                                ‚Üì
                                    Broadcast "player_moved" –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º
                                                ‚Üì
                            Unity –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ ‚Üí NetworkSyncManager.OnPlayerMoved()
                                                ‚Üì
                                        –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ NetworkPlayer
```

### 3. –ê—Ç–∞–∫–∞

```
–ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç:
Unity ‚Üí CombatSystem.Attack() ‚Üí SocketIOClient.SendAttack()
                                        ‚Üì
                                Emit "player_attack"
                                        ‚Üì
                            Server (multiplayer.js)
                                        ‚Üì
                        Broadcast "player_attacked" –≤—Å–µ–º –≤ –∫–æ–º–Ω–∞—Ç–µ
                                        ‚Üì
        Unity –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ ‚Üí NetworkSyncManager.OnPlayerAttacked()
                                        ‚Üì
                        –¶–µ–ª—å ‚Üí ApplyDamage() ‚Üí SendDamage()
                                        ‚Üì
                                Emit "player_damaged"
                                        ‚Üì
                            Server (multiplayer.js)
                                        ‚Üì
                    Broadcast "player_health_changed" –≤—Å–µ–º
```

### 4. –í—Ä–∞–≥–∏ (NPC)

```
–ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç –≤—Ä–∞–≥–∞:
Unity ‚Üí Enemy.TakeDamage() ‚Üí SocketIOClient.SendEnemyDamaged()
                                        ‚Üì
                                Emit "enemy_damaged"
                                        ‚Üì
                            Server (multiplayer.js)
                                        ‚Üì
                        Broadcast "enemy_health_changed" –≤—Å–µ–º
                                        ‚Üì
                    Unity –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ ‚Üí –û–±–Ω–æ–≤–∏—Ç—å HP –≤—Ä–∞–≥–∞

–í—Ä–∞–≥ —É–º–∏—Ä–∞–µ—Ç:
Unity ‚Üí Enemy.Die() ‚Üí SocketIOClient.SendEnemyKilled()
                                ‚Üì
                        Emit "enemy_killed"
                                ‚Üì
                    Server (multiplayer.js)
                                ‚Üì
                Broadcast "enemy_died" –≤—Å–µ–º
                                ‚Üì
        Unity –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å —Å–º–µ—Ä—Ç—å –≤—Ä–∞–≥–∞
```

---

## üìà –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ù–û–í–û–ô –°–ò–°–¢–ï–ú–´

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π**: 10 Hz (–≤–º–µ—Å—Ç–æ 1 Hz)
- **–ó–∞–¥–µ—Ä–∂–∫–∞**: 50-200 –º—Å (–≤–º–µ—Å—Ç–æ 1-2 —Å–µ–∫)
- **Bandwidth**: –ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –±–ª–∞–≥–æ–¥–∞—Ä—è WebSocket

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **–ê–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç**: Socket.IO –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- **Heartbeat**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫
- **Fallback**: –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å polling –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- **Rooms**: –ò–≥—Ä–æ–∫–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º
- **Memory efficient**: –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
- **Auto-cleanup**: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç

---

## üéÆ –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú–´–ï –î–ê–ù–ù–´–ï

### –ü–µ—Ä—Å–æ–Ω–∞–∂–∏

| –î–∞–Ω–Ω—ã–µ | –ß–∞—Å—Ç–æ—Ç–∞ | –†–∞–∑–º–µ—Ä |
|--------|---------|--------|
| Position (x,y,z) | 10 Hz | 12 bytes |
| Rotation (x,y,z) | 10 Hz | 12 bytes |
| Velocity (x,y,z) | 10 Hz | 12 bytes |
| Animation State | –ü—Ä–∏ —Å–º–µ–Ω–µ | ~20 bytes |
| Health/Mana | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ | 16 bytes |

**–û–±—â–∏–π —Ç—Ä–∞—Ñ–∏–∫**: ~400-500 bytes/sec –Ω–∞ –∏–≥—Ä–æ–∫–∞

### –í—Ä–∞–≥–∏

| –î–∞–Ω–Ω—ã–µ | –ß–∞—Å—Ç–æ—Ç–∞ | –†–∞–∑–º–µ—Ä |
|--------|---------|--------|
| Health | –ü—Ä–∏ —É—Ä–æ–Ω–µ | 16 bytes |
| Death | –ü—Ä–∏ —Å–º–µ—Ä—Ç–∏ | 50 bytes |
| Respawn | –ü—Ä–∏ —Ä–µ—Å–ø–∞–≤–Ω–µ | 50 bytes |

**–¢—Ä–∞—Ñ–∏–∫**: –¢–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö (event-driven)

---

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### Server (multiplayer.js)
```javascript
activePlayers = new Map(); // socketId => player data
roomEnemies = new Map();   // roomId => Map(enemyId => enemy data)
timeout = 5 * 60 * 1000;   // 5 minutes cleanup
```

### Client (SocketIOClient.cs)
```csharp
heartbeatInterval = 20f;  // 20 seconds
pollInterval = 0.05f;     // 20 Hz (50ms)
```

### NetworkSyncManager
```csharp
positionSyncInterval = 0.1f;  // 10 Hz
```

---

## üêõ DEBUG –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (multiplayer.js)
```
‚úÖ Player connected: abc123
[Join Room] Username joining room room_xxx as Warrior
‚úÖ Username joined room room_xxx. Total players: 2
[Attack] Username attacking enemy (ID: enemy_1)
‚ùå Player disconnected: Username (abc123)
```

### –õ–æ–≥–∏ Unity (SocketIOClient)
```
[SocketIO] üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ https://...
[SocketIO] ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! Session ID: abc123
[SocketIO] üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: player_update
[SocketIO] üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: player_moved
[SocketIO] ‚öîÔ∏è –ê—Ç–∞–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: enemy enemy_1, —É—Ä–æ–Ω 50
```

### –õ–æ–≥–∏ Unity (NetworkSyncManager)
```
[NetworkSync] üì¶ –ü–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ
[NetworkSync] –í –∫–æ–º–Ω–∞—Ç–µ 2 –∏–≥—Ä–æ–∫–æ–≤
[NetworkSync] üé≠ Spawning network player: OtherPlayer
[NetworkSync] ‚öîÔ∏è –ê—Ç–∞–∫–∞: socketId, —Ç–∏–ø: melee, —Ü–µ–ª—å: enemy enemy_1
[NetworkSync] üí• –ú—ã –ø–æ–ª—É—á–∏–ª–∏ —É—Ä–æ–Ω: 25
[NetworkSync] üê∫ –í—Ä–∞–≥ enemy_1 –ø–æ–ª—É—á–∏–ª —É—Ä–æ–Ω: 50
```

---

## ‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### Unit Tests (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)
```csharp
// TODO: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è:
- SocketIOClient.Connect()
- SocketIOClient.JoinRoom()
- NetworkSyncManager.SpawnNetworkPlayer()
- NetworkSyncManager.OnPlayerMoved()
```

### Integration Tests
1. ‚úÖ –û–¥–∏–Ω–æ—á–Ω—ã–π –∏–≥—Ä–æ–∫ - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –¥–≤–∏–∂–µ–Ω–∏–µ
2. ‚úÖ –î–≤–∞ –∏–≥—Ä–æ–∫–∞ - –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞
3. ‚úÖ –ê—Ç–∞–∫–∏ - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è
4. ‚è≥ –í—Ä–∞–≥–∏ - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å enemy manager)
5. ‚è≥ –†–µ—Å–ø–∞–≤–Ω - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üöÄ –ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ!

–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ [SOCKETIO_SETUP_GUIDE.md](SOCKETIO_SETUP_GUIDE.md) –¥–ª—è:
1. –£—Å—Ç–∞–Ω–æ–≤–∫–∏ Socket.IO –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –î–µ–ø–ª–æ—è –Ω–∞ Render.com
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Unity —Å—Ü–µ–Ω—ã
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞

**–£—Å–ø–µ—Ö–æ–≤ —Å –≤–∞—à–µ–π MMO –∏–≥—Ä–æ–π! üéÆ‚ú®**
