# üõ†Ô∏è –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô –î–õ–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –°–ö–ò–õ–õ–û–í

## ‚ö†Ô∏è **–í–ê–ñ–ù–û: –ó–∞–∫—Ä–æ–π—Ç–µ Unity Editor –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º!**

Unity –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã .cs –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ —à–∞–≥–∏:

---

## **–®–ê–ì 1: –î–æ–±–∞–≤–∏—Ç—å SendSkillUsed –≤ NetworkCombatSync.cs**

–û—Ç–∫—Ä–æ–π—Ç–µ `Assets/Scripts/Network/NetworkCombatSync.cs`

–ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ `OnDestroy()` (–≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞) –∏ **–ü–ï–†–ï–î –ù–ò–ú** –¥–æ–±–∞–≤—å—Ç–µ:

```csharp
    /// <summary>
    /// ‚úÖ –ù–û–í–´–ô –ú–ï–¢–û–î: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫–∏–ª–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    /// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ PlayerAttack.UseSkillDirectly() –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ UseSkill()
    /// </summary>
    public void SendSkillUsed(int skillId, string animationTrigger, Vector3 targetPosition, float castTime)
    {
        if (!enableSync || !isMultiplayer || SocketIOManager.Instance == null)
        {
            Debug.Log("[NetworkCombatSync] SendSkillUsed –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä)");
            return;
        }

        if (!SocketIOManager.Instance.IsConnected)
        {
            Debug.LogWarning("[NetworkCombatSync] SendSkillUsed –ø—Ä–æ–ø—É—â–µ–Ω - –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É");
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∫–∏–ª–ª–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        SocketIOManager.Instance.SendSkillUsed(skillId, animationTrigger, targetPosition, castTime);

        Debug.Log($"[NetworkCombatSync] üì° –°–∫–∏–ª–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ID={skillId}, trigger={animationTrigger}, castTime={castTime}—Å");
    }
```

---

## **–®–ê–ì 2: –î–æ–±–∞–≤–∏—Ç—å SendSkillUsed –≤ SocketIOManager.cs**

–û—Ç–∫—Ä–æ–π—Ç–µ `Assets/Scripts/Network/SocketIOManager.cs`

–ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ `SendProjectileSpawned()` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 489) –∏ **–ü–û–°–õ–ï –ù–ï–ì–û** –¥–æ–±–∞–≤—å—Ç–µ:

```csharp
    /// <summary>
    /// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫–∏–ª–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    /// </summary>
    public void SendSkillUsed(int skillId, string animationTrigger, Vector3 targetPosition, float castTime)
    {
        if (!IsConnected)
        {
            DebugLog("‚ö†Ô∏è SendSkillUsed: –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ —Å–µ—Ä–≤–µ—Ä—É");
            return;
        }

        var data = new
        {
            skillId = skillId,
            animationTrigger = animationTrigger,
            targetPosition = new { x = targetPosition.x, y = targetPosition.y, z = targetPosition.z },
            castTime = castTime,
            timestamp = GetTimestamp()
        };

        string json = JsonConvert.SerializeObject(data);
        Emit("player_used_skill", json);

        DebugLog($"‚ö° –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∫–∏–ª–ª–∞: ID={skillId}, trigger={animationTrigger}, castTime={castTime}—Å");
    }
```

---

## **–®–ê–ì 3: –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ –≤ PlayerAttack.cs**

–û—Ç–∫—Ä–æ–π—Ç–µ `Assets/Scripts/Player/PlayerAttack.cs`

–ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ `UseSkillDirectly()` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 1120), –Ω–∞–π–¥–∏—Ç–µ –±–ª–æ–∫:

```csharp
if (success)
{
    Debug.Log($"[PlayerAttack] ‚ö° –°–∫–∏–ª–ª {skill.skillName} –£–°–ü–ï–®–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!");
}
```

**–ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞:**

```csharp
if (success)
{
    Debug.Log($"[PlayerAttack] ‚ö° –°–∫–∏–ª–ª {skill.skillName} –£–°–ü–ï–®–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!");

    // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    NetworkCombatSync networkSync = GetComponent<NetworkCombatSync>();
    if (networkSync != null && networkSync.enabled)
    {
        Vector3 targetPos = target != null ? target.position : transform.position + transform.forward * 10f;
        networkSync.SendSkillUsed(skill.skillId, skill.animationTrigger, targetPos, skill.castTime);
        Debug.Log($"[PlayerAttack] üì° –°–∫–∏–ª–ª {skill.skillName} (ID:{skill.skillId}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä");
    }
}
```

---

## **–®–ê–ì 4: –ò—Å–ø—Ä–∞–≤–∏—Ç—å targetSocketId –≤ EffectManager.cs**

–û—Ç–∫—Ä–æ–π—Ç–µ `Assets/Scripts/Skills/EffectManager.cs`

–ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ `SendEffectToServer()` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 620-630) –∏ **–ó–ê–ú–ï–ù–ò–¢–ï –µ–≥–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞:**

```csharp
    /// <summary>
    /// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏
    /// </summary>
    private void SendEffectToServer(ActiveEffect effect)
    {
        NetworkCombatSync networkSync = GetComponent<NetworkCombatSync>();
        if (networkSync != null && networkSync.enabled)
        {
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º targetSocketId –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
            string targetSocketId = GetMySocketId();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º targetSocketId
            if (SocketIOManager.Instance != null && SocketIOManager.Instance.IsConnected)
            {
                SocketIOManager.Instance.SendEffectApplied(effect.config, targetSocketId);
                Log($"üì° –≠—Ñ—Ñ–µ–∫—Ç {effect.config.effectType} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä (target={targetSocketId})");
            }
        }
    }

    /// <summary>
    /// –ü–æ–ª—É—á–∏—Ç—å –º–æ–π socketId –∏–∑ SocketIOManager
    /// </summary>
    private string GetMySocketId()
    {
        if (SocketIOManager.Instance != null && SocketIOManager.Instance.IsConnected)
        {
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—à socketId
            return SocketIOManager.Instance.SessionId;
        }
        return "";
    }
```

---

## **–®–ê–ì 5: –£–ª—É—á—à–∏—Ç—å OnEffectApplied –≤ NetworkSyncManager.cs**

–û—Ç–∫—Ä–æ–π—Ç–µ `Assets/Scripts/Network/NetworkSyncManager.cs`

–ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ `OnEffectApplied()` (–æ–∫–æ–ª–æ —Å—Ç—Ä–æ–∫–∏ 1067-1150) –∏ –Ω–∞–π–¥–∏—Ç–µ –±–ª–æ–∫ –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è `targetTransform`:

```csharp
if (targetTransform != null)
{
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
```

**–î–û–ë–ê–í–¨–¢–ï –ü–û–°–õ–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ if:**

```csharp
            // ‚úÖ –ù–û–í–û–ï: –°–û–ó–î–ê–Å–ú –í–ò–ó–£–ê–õ–¨–ù–£–Æ –ê–£–†–£
            if (!string.IsNullOrEmpty(data.particleEffectPrefabName))
            {
                GameObject particlePrefab = Resources.Load<GameObject>($"Effects/{data.particleEffectPrefabName}");

                if (particlePrefab != null)
                {
                    // –°–æ–∑–¥–∞—ë–º –∞—É—Ä—É –∫–∞–∫ child –æ–±—ä–µ–∫—Ç –∏–≥—Ä–æ–∫–∞
                    GameObject aura = Instantiate(particlePrefab, targetTransform);
                    aura.transform.localPosition = Vector3.up * 1f; // 1 –º–µ—Ç—Ä –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π
                    aura.transform.localRotation = Quaternion.Euler(-90f, 0f, 0f); // –ü–æ–≤–æ—Ä–æ—Ç –≤–Ω–∏–∑

                    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ duration —Å–µ–∫—É–Ω–¥
                    Destroy(aura, data.duration);

                    Debug.Log($"[NetworkSync] ‚ú® –ê—É—Ä–∞ {data.effectType} —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è {targetTransform.name} –Ω–∞ {data.duration} —Å–µ–∫—É–Ω–¥");
                }
                else
                {
                    Debug.LogWarning($"[NetworkSync] ‚ö†Ô∏è Particle prefab –Ω–µ –Ω–∞–π–¥–µ–Ω: Effects/{data.particleEffectPrefabName}");
                }
            }
```

---

## üß™ **–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:**

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ Unity Editor**
2. **–î–æ–∂–¥–∏—Ç–µ—Å—å –ø–µ—Ä–µ–∫–æ–º–ø–∏–ª—è—Ü–∏–∏** (Build Succeeded)
3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ 2 –∫–ª–∏–µ–Ω—Ç–∞:**
   - –ö–ª–∏–µ–Ω—Ç 1: –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É ‚Üí –í—ã–±—Ä–∞—Ç—å Archer ‚Üí –í–æ–π—Ç–∏ –≤ –∞—Ä–µ–Ω—É
   - –ö–ª–∏–µ–Ω—Ç 2: –í–æ–π—Ç–∏ –≤ —Ç—É –∂–µ –∫–æ–º–Ω–∞—Ç—É ‚Üí –í—ã–±—Ä–∞—Ç—å –ª—é–±–æ–π –∫–ª–∞—Å—Å ‚Üí –í–æ–π—Ç–∏ –≤ –∞—Ä–µ–Ω—É
4. **–ò–≥—Ä–æ–∫ 1 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Eagle Eye (–∫–Ω–æ–ø–∫–∞ 4)**

### **–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**

**–ö–ª–∏–µ–Ω—Ç 1 (–ò–≥—Ä–æ–∫ A):**
```
[PlayerAttack] üì° –°–∫–∏–ª–ª Eagle Eye (ID:303) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
[NetworkCombatSync] üì° –°–∫–∏–ª–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ID=303, trigger=Skill, castTime=0—Å
[SocketIO] ‚ö° –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∫–∏–ª–ª–∞: ID=303, trigger=Skill, castTime=0—Å
[EffectManager] üì° –≠—Ñ—Ñ–µ–∫—Ç IncreasePerception –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä (target=xyz...)
```

**–ö–ª–∏–µ–Ω—Ç 2 (–ò–≥—Ä–æ–∫ B):**
```
[NetworkSync] ‚ö° RAW player_used_skill JSON: {...}
[NetworkSync] ‚ö° –°–∫–∏–ª–ª –ø–æ–ª—É—á–µ–Ω: socketId=xyz, skillId=303
[NetworkSync] üé¨ –ê–Ω–∏–º–∞—Ü–∏—è 'Skill' –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è PlayerA
[NetworkSync] ‚ú® RAW effect_applied JSON: {...}
[NetworkSync] ‚ú® –≠—Ñ—Ñ–µ–∫—Ç IncreasePerception –ø—Ä–∏–º–µ–Ω—ë–Ω –Ω–∞ PlayerA
[NetworkSync] ‚ú® –ê—É—Ä–∞ IncreasePerception —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è PlayerA –Ω–∞ 15 —Å–µ–∫—É–Ω–¥  ‚Üê ‚úÖ –ù–û–í–û–ï!
```

---

## ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢:**

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –ò–≥—Ä–æ–∫ B **–≤–∏–¥–∏—Ç** –∞–Ω–∏–º–∞—Ü–∏—é –∫–∞—Å—Ç–∞ Eagle Eye
- ‚úÖ –ò–≥—Ä–æ–∫ B **–≤–∏–¥–∏—Ç** –∑–æ–ª–æ—Ç—É—é –∞—É—Ä—É –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π –ò–≥—Ä–æ–∫–∞ A
- ‚úÖ –°–∫–∏–ª–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
- ‚úÖ `targetSocketId` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è

---

## üö® **–ï–°–õ–ò –ù–ï –†–ê–ë–û–¢–ê–ï–¢:**

### **–ü—Ä–æ–±–ª–µ–º–∞: "Parameter 'Skill' does not exist"**

**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–∏—Ç–µ `animationTrigger` –≤ SkillConfig:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `Assets/Resources/Skills/Archer_EagleEye.asset` –≤ Inspector
2. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª–µ `Animation Trigger`
3. –ò–∑–º–µ–Ω–∏—Ç–µ —Å `"Skill"` –Ω–∞ `"Attack"` (–∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ ArcherAnimator)
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ (Ctrl+S)

### **–ü—Ä–æ–±–ª–µ–º–∞: "SessionId –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"**

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∏—Ç–µ `SocketIOManager.Instance.SessionId` –Ω–∞:

```csharp
private string GetMySocketId()
{
    // –ò—â–µ–º –Ω–∞—à socket.id —á–µ—Ä–µ–∑ NetworkSyncManager
    if (NetworkSyncManager.Instance != null)
    {
        return NetworkSyncManager.Instance.GetLocalPlayerSocketId();
    }
    return "";
}
```

–ê –≤ `NetworkSyncManager.cs` –¥–æ–±–∞–≤—å—Ç–µ:

```csharp
public string GetLocalPlayerSocketId()
{
    return localPlayerSocketId;
}
```

---

**–ì–æ—Ç–æ–≤–æ! –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã! üéâ**
